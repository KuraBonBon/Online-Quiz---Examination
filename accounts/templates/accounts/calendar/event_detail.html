{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}{{ event.title }} - SPIST Calendar{% endblock %}

{% block extra_css %}
<style>
    :root {
        --detail-primary: #004d40;
        --detail-secondary: #00695c;
        --detail-accent: #26a69a;
        --detail-bg: #ffffff;
        --detail-text: #333333;
        --detail-muted: #6c757d;
        --detail-border: #e0e0e0;
    }

    [data-theme="dark"] {
        --detail-primary: #26a69a;
        --detail-secondary: #4db6ac;
        --detail-accent: #80cbc4;
        --detail-bg: #2d2d2d;
        --detail-text: #ffffff;
        --detail-muted: #adb5bd;
        --detail-border: #444444;
    }

    .event-detail-container {
        background: var(--detail-bg);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .event-header {
        background: linear-gradient(135deg, var(--detail-primary), var(--detail-secondary));
        color: white;
        padding: 2rem;
        position: relative;
    }

    .event-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20'%3E%3Cpath d='m0 20c20-10 40-10 60 0s40 10 60 0v-20h-120z' fill='%23ffffff' opacity='0.1'/%3E%3C/svg%3E") repeat-x bottom;
    }

    .event-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        position: relative;
        z-index: 1;
    }

    .event-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
        position: relative;
        z-index: 1;
    }

    .event-badges {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
        position: relative;
        z-index: 1;
    }

    .event-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .badge-category {
        background: rgba(255,255,255,0.2);
        color: white;
    }

    .badge-priority-normal {
        background: #6c757d;
        color: white;
    }

    .badge-priority-high {
        background: #f44336;
        color: white;
    }

    .badge-priority-critical {
        background: #d32f2f;
        color: white;
        animation: pulse 2s infinite;
    }

    .badge-type {
        background: rgba(255,255,255,0.15);
        color: white;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .event-body {
        padding: 2rem;
    }

    .event-section {
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--detail-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .event-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .info-card {
        background: rgba(38, 166, 154, 0.05);
        border: 1px solid var(--detail-border);
        border-radius: 8px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .info-icon {
        width: 40px;
        height: 40px;
        background: var(--detail-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.25rem;
    }

    .info-title {
        font-weight: 600;
        color: var(--detail-text);
        margin-bottom: 0.5rem;
    }

    .info-content {
        color: var(--detail-muted);
        line-height: 1.5;
    }

    .description-card {
        background: var(--detail-bg);
        border: 1px solid var(--detail-border);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .description-text {
        color: var(--detail-text);
        line-height: 1.6;
        margin: 0;
        white-space: pre-wrap;
    }

    .participants-section {
        background: rgba(38, 166, 154, 0.05);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .participant-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .participant-badge {
        background: var(--detail-accent);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .related-content {
        background: var(--detail-bg);
        border: 1px solid var(--detail-border);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .related-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(38, 166, 154, 0.05);
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .related-item:hover {
        background: rgba(38, 166, 154, 0.1);
        transform: translateX(5px);
    }

    .related-icon {
        width: 32px;
        height: 32px;
        background: var(--detail-accent);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
    }

    .related-info h6 {
        margin: 0;
        color: var(--detail-text);
        font-size: 0.95rem;
    }

    .related-info small {
        color: var(--detail-muted);
        font-size: 0.8rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 2rem;
        border-top: 1px solid var(--detail-border);
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: var(--detail-primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--detail-secondary);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }

    .btn-outline {
        background: transparent;
        color: var(--detail-primary);
        border: 2px solid var(--detail-primary);
    }

    .btn-outline:hover {
        background: var(--detail-primary);
        color: white;
        text-decoration: none;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
        color: white;
        text-decoration: none;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: 1rem;
    }

    .status-upcoming {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .status-ongoing {
        background: #e8f5e8;
        color: #388e3c;
        border: 1px solid #c8e6c9;
    }

    .status-past {
        background: #fafafa;
        color: #616161;
        border: 1px solid #e0e0e0;
    }

    [data-theme="dark"] .status-upcoming {
        background: #1a237e;
        color: #90caf9;
        border-color: #3f51b5;
    }

    [data-theme="dark"] .status-ongoing {
        background: #1b5e20;
        color: #a5d6a7;
        border-color: #4caf50;
    }

    [data-theme="dark"] .status-past {
        background: #424242;
        color: #bdbdbd;
        border-color: #616161;
    }

    @media (max-width: 768px) {
        .event-header {
            padding: 1.5rem;
        }
        
        .event-title {
            font-size: 1.5rem;
        }
        
        .event-body {
            padding: 1rem;
        }
        
        .event-info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Back Navigation -->
            <div class="mb-3">
                <a href="{% url 'accounts:calendar_view' %}" class="btn-outline btn">
                    <i class="fas fa-arrow-left"></i>
                    Back to Calendar
                </a>
            </div>

            <div class="event-detail-container">
                <!-- Event Header -->
                <div class="event-header">
                    <h1 class="event-title">{{ event.title }}</h1>
                    {% if event.description %}
                        <p class="event-subtitle">{{ event.description|truncatechars:100 }}</p>
                    {% endif %}
                    
                    <div class="event-badges">
                        <span class="event-badge badge-category" style="background-color: {{ event.category.color }};">
                            <i class="{{ event.category.icon }}"></i>
                            {{ event.category.name }}
                        </span>
                        <span class="event-badge badge-priority-{{ event.priority }}">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ event.get_priority_display }}
                        </span>
                        <span class="event-badge badge-type">
                            <i class="fas fa-tag"></i>
                            {{ event.get_event_type_display }}
                        </span>
                    </div>

                    <!-- Status Indicator -->
                    <div class="status-indicator status-{{ event.status }}">
                        <i class="fas fa-{% if event.status == 'upcoming' %}clock{% elif event.status == 'ongoing' %}play{% else %}check{% endif %}"></i>
                        {% if event.status == 'upcoming' %}
                            Upcoming Event
                        {% elif event.status == 'ongoing' %}
                            Happening Now
                        {% else %}
                            Past Event
                        {% endif %}
                    </div>
                </div>

                <!-- Event Body -->
                <div class="event-body">
                    <!-- Event Information Grid -->
                    <div class="event-info-grid">
                        <!-- Date & Time -->
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="info-title">Date & Time</div>
                            <div class="info-content">
                                <strong>{{ event.start_date|date:"F d, Y" }}</strong>
                                {% if event.end_date and event.end_date != event.start_date %}
                                    <br>to {{ event.end_date|date:"F d, Y" }}
                                {% endif %}
                                {% if event.start_time %}
                                    <br>
                                    <i class="fas fa-clock me-1"></i>
                                    {{ event.start_time|time:"g:i A" }}
                                    {% if event.end_time %}
                                        - {{ event.end_time|time:"g:i A" }}
                                    {% endif %}
                                {% else %}
                                    <br><em>All day event</em>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Location -->
                        {% if event.location %}
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="info-title">Location</div>
                            <div class="info-content">
                                {{ event.location }}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Created By -->
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="info-title">Organized By</div>
                            <div class="info-content">
                                {{ event.created_by.get_full_name|default:event.created_by.username }}
                                <br>
                                <small>{{ event.created_by.get_user_type_display }}</small>
                            </div>
                        </div>

                        <!-- Duration -->
                        {% if event.duration %}
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="info-title">Duration</div>
                            <div class="info-content">
                                {{ event.duration }}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    {% if event.description %}
                    <div class="event-section">
                        <h3 class="section-title">
                            <i class="fas fa-align-left"></i>
                            Description
                        </h3>
                        <div class="description-card">
                            <p class="description-text">{{ event.description }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Target Audience -->
                    <div class="event-section">
                        <h3 class="section-title">
                            <i class="fas fa-users"></i>
                            Target Audience
                        </h3>
                        <div class="participants-section">
                            <div class="participant-badges">
                                {% if event.audience_all %}
                                    <span class="participant-badge">
                                        <i class="fas fa-globe"></i>
                                        All Users
                                    </span>
                                {% else %}
                                    {% if event.audience_students %}
                                        <span class="participant-badge">
                                            <i class="fas fa-user-graduate"></i>
                                            Students
                                        </span>
                                    {% endif %}
                                    {% if event.audience_teachers %}
                                        <span class="participant-badge">
                                            <i class="fas fa-chalkboard-teacher"></i>
                                            Teachers
                                        </span>
                                    {% endif %}
                                    {% if event.audience_staff %}
                                        <span class="participant-badge">
                                            <i class="fas fa-user-tie"></i>
                                            Staff
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Related Content -->
                    {% if event.related_assessment %}
                    <div class="event-section">
                        <h3 class="section-title">
                            <i class="fas fa-link"></i>
                            Related Content
                        </h3>
                        <div class="related-content">
                            <div class="related-item">
                                <div class="related-icon">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <div class="related-info flex-grow-1">
                                    <h6>
                                        <a href="{% url 'assessments:view_assessment' event.related_assessment.pk %}" 
                                           class="text-decoration-none">
                                            {{ event.related_assessment.title }}
                                        </a>
                                    </h6>
                                    <small>
                                        {{ event.related_assessment.get_assessment_type_display }}
                                        • {{ event.related_assessment.course.name }}
                                        • Due: {{ event.related_assessment.due_date|date:"M j, Y" }}
                                    </small>
                                </div>
                                <div>
                                    <a href="{% url 'assessments:view_assessment' event.related_assessment.pk %}" 
                                       class="btn btn-sm btn-outline">
                                        View Assessment
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Event Metadata -->
                    <div class="event-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Event Details
                        </h3>
                        <div class="event-info-grid">
                            <div class="info-card">
                                <div class="info-icon">
                                    <i class="fas fa-calendar-plus"></i>
                                </div>
                                <div class="info-title">Created</div>
                                <div class="info-content">
                                    {{ event.created_at|date:"F d, Y" }}
                                    <br>
                                    <small>{{ event.created_at|time:"g:i A" }}</small>
                                </div>
                            </div>

                            {% if event.updated_at != event.created_at %}
                            <div class="info-card">
                                <div class="info-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="info-title">Last Modified</div>
                                <div class="info-content">
                                    {{ event.updated_at|date:"F d, Y" }}
                                    <br>
                                    <small>{{ event.updated_at|time:"g:i A" }}</small>
                                </div>
                            </div>
                            {% endif %}

                            {% if event.send_notification %}
                            <div class="info-card">
                                <div class="info-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="info-title">Notifications</div>
                                <div class="info-content">
                                    Enabled
                                    <br>
                                    <small>Users will be notified</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        {% if user == event.created_by or user.is_staff %}
                            <a href="{% url 'accounts:edit_event' event.pk %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i>
                                Edit Event
                            </a>
                            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                                <i class="fas fa-trash"></i>
                                Delete Event
                            </button>
                        {% endif %}
                        
                        {% if event.related_assessment %}
                            <a href="{% url 'assessments:view_assessment' event.related_assessment.pk %}" 
                               class="btn btn-secondary">
                                <i class="fas fa-clipboard-check"></i>
                                View Assessment
                            </a>
                        {% endif %}
                        
                        <button type="button" class="btn btn-outline" onclick="shareEvent()">
                            <i class="fas fa-share"></i>
                            Share Event
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if user == event.created_by or user.is_staff %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this event? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{{ event.title }}</strong> will be permanently removed from the calendar.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'accounts:delete_event' event.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Event</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function shareEvent() {
    const url = window.location.href;
    const title = '{{ event.title|escapejs }}';
    const text = 'Check out this event: {{ event.title|escapejs }}';
    
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text,
            url: url
        }).catch(console.error);
    } else {
        // Fallback to clipboard
        navigator.clipboard.writeText(url).then(() => {
            alert('Event link copied to clipboard!');
        }).catch(() => {
            // Final fallback
            prompt('Copy this link:', url);
        });
    }
}

// Add to calendar functionality
function addToCalendar() {
    const startDate = new Date('{{ event.start_date|date:"c" }}');
    const endDate = {% if event.end_date %}new Date('{{ event.end_date|date:"c" }}'){% else %}startDate{% endif %};
    
    {% if event.start_time %}
        const startTime = '{{ event.start_time|time:"H:i" }}'.split(':');
        startDate.setHours(parseInt(startTime[0]), parseInt(startTime[1]));
    {% endif %}
    
    {% if event.end_time %}
        const endTime = '{{ event.end_time|time:"H:i" }}'.split(':');
        endDate.setHours(parseInt(endTime[0]), parseInt(endTime[1]));
    {% else %}
        endDate.setHours(23, 59);
    {% endif %}
    
    const event = {
        title: '{{ event.title|escapejs }}',
        start: startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z',
        end: endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z',
        description: '{{ event.description|escapejs }}',
        location: '{{ event.location|escapejs }}'
    };
    
    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.title)}&dates=${event.start}/${event.end}&details=${encodeURIComponent(event.description)}&location=${encodeURIComponent(event.location)}`;
    
    window.open(calendarUrl, '_blank');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'e':
                {% if user == event.created_by or user.is_staff %}
                e.preventDefault();
                window.location.href = '{% url "accounts:edit_event" event.pk %}';
                {% endif %}
                break;
            case 'Backspace':
                e.preventDefault();
                window.location.href = '{% url "accounts:calendar_view" %}';
                break;
        }
    }
});
</script>
{% endblock %}