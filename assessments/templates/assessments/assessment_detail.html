{% extends 'accounts/base.html' %}
{% load assessment_filters %}

{% block title %}SPIST - Assessment Details{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2>{{ assessment.title }}</h2>
            <p>{{ assessment.get_assessment_type_display }} • {{ assessment.get_status_display }}</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            {% if assessment.creator == user %}
                <a href="{% url 'assessments:edit_assessment' assessment.id %}" class="btn">Edit Settings</a>
                <a href="{% url 'assessments:add_question' assessment.id %}" class="btn" style="background-color: #4caf50;">Add Questions</a>
                {% if assessment.status == 'draft' and questions.count > 0 %}
                <form method="post" action="{% url 'assessments:publish_assessment' assessment.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background-color: #2e7d32;">Publish</button>
                </form>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Main Content -->
    <div>
        <!-- Assessment Description -->
        {% if assessment.description %}
        <div class="card">
            <h3>Description</h3>
            <p>{{ assessment.description }}</p>
        </div>
        {% endif %}
        
        <!-- Questions List -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Questions ({{ questions.count }})</h3>
                {% if assessment.creator == user %}
                <a href="{% url 'assessments:manage_questions' assessment.id %}" class="btn" style="font-size: 14px; padding: 0.5rem 1rem;">Manage All</a>
                {% endif %}
            </div>
            
            {% if questions %}
                {% for question in questions %}
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 0.5rem;">
                                {{ forloop.counter }}. {{ question.question_text }}
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                {{ question.get_question_type_display }} • {{ question.points }} point{{ question.points|pluralize }}
                            </div>
                        </div>
                        {% if assessment.creator == user %}
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{% url 'assessments:edit_question' question.id %}" 
                               style="font-size: 12px; color: #2e7d32; text-decoration: none; padding: 0.25rem 0.5rem; border: 1px solid #2e7d32; border-radius: 4px;">
                                Edit
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Show choices/answers based on question type -->
                    {% if question.question_type == 'multiple_choice' %}
                        <div style="margin-left: 1rem;">
                            {% for choice in question.choices.all %}
                            <div style="margin: 0.25rem 0; {% if choice.is_correct %}color: #2e7d32; font-weight: 500;{% endif %}">
                                {{ forloop.counter|add:"96"|chr_filter }}. {{ choice.choice_text }}
                                {% if choice.is_correct %}<span style="color: #2e7d32;">✓</span>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% elif question.question_type == 'true_false' %}
                        <div style="margin-left: 1rem;">
                            {% for choice in question.choices.all %}
                            <div style="margin: 0.25rem 0; {% if choice.is_correct %}color: #2e7d32; font-weight: 500;{% endif %}">
                                {{ choice.choice_text }}
                                {% if choice.is_correct %}<span style="color: #2e7d32;">✓</span>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% elif question.question_type in 'identification,enumeration,essay'|split:',' %}
                        {% if question.correct_answers.exists %}
                        <div style="margin-left: 1rem;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 0.5rem;">Expected Answer(s):</div>
                            {% for answer in question.correct_answers.all %}
                            <div style="margin: 0.25rem 0; color: #2e7d32;">
                                • {{ answer.answer_text }}
                                {% if answer.is_case_sensitive %}<small style="color: #666;">(case sensitive)</small>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <p>No questions added yet.</p>
                    {% if assessment.creator == user %}
                    <a href="{% url 'assessments:add_question' assessment.id %}" class="btn" style="margin-top: 1rem;">Add First Question</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Sidebar -->
    <div>
        <!-- Assessment Info -->
        <div class="card">
            <h3>Assessment Info</h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 14px;">
                <div>
                    <strong>Type:</strong> {{ assessment.get_assessment_type_display }}
                </div>
                <div>
                    <strong>Status:</strong> 
                    <span style="padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 12px; font-weight: bold;
                                 {% if assessment.status == 'published' %}background-color: #e8f5e8; color: #2e7d32;
                                 {% elif assessment.status == 'draft' %}background-color: #fff3e0; color: #f57c00;
                                 {% else %}background-color: #f5f5f5; color: #666;{% endif %}">
                        {{ assessment.get_status_display }}
                    </span>
                </div>
                <div>
                    <strong>Created:</strong> {{ assessment.created_at|date:"M d, Y H:i" }}
                </div>
                <div>
                    <strong>Updated:</strong> {{ assessment.updated_at|date:"M d, Y H:i" }}
                </div>
                <div>
                    <strong>Creator:</strong> {{ assessment.creator.get_full_name }}
                </div>
            </div>
        </div>
        
        <!-- Settings -->
        <div class="card">
            <h3>Settings</h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 14px;">
                {% if assessment.time_limit %}
                <div>
                    <strong>Time Limit:</strong> {{ assessment.time_limit }} minutes
                </div>
                {% else %}
                <div>
                    <strong>Time Limit:</strong> No limit
                </div>
                {% endif %}
                
                <div>
                    <strong>Max Attempts:</strong> {{ assessment.max_attempts }}
                </div>
                
                <div>
                    <strong>Passing Score:</strong> {{ assessment.passing_score }}%
                </div>
                
                <div>
                    <strong>Show Answers:</strong> {% if assessment.show_correct_answers %}Yes{% else %}No{% endif %}
                </div>
                
                <div>
                    <strong>Randomize Questions:</strong> {% if assessment.randomize_questions %}Yes{% else %}No{% endif %}
                </div>
                
                <div>
                    <strong>Randomize Choices:</strong> {% if assessment.randomize_choices %}Yes{% else %}No{% endif %}
                </div>
            </div>
        </div>
        
        <!-- Availability -->
        {% if assessment.available_from or assessment.available_until %}
        <div class="card">
            <h3>Availability</h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 14px;">
                {% if assessment.available_from %}
                <div>
                    <strong>Available From:</strong><br>
                    {{ assessment.available_from|date:"M d, Y H:i" }}
                </div>
                {% endif %}
                
                {% if assessment.available_until %}
                <div>
                    <strong>Available Until:</strong><br>
                    {{ assessment.available_until|date:"M d, Y H:i" }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Actions -->
        {% if assessment.creator == user %}
        <div class="card">
            <h3>Actions</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <a href="{% url 'assessments:my_assessments' %}" class="btn" style="font-size: 14px; padding: 0.5rem 1rem;">← Back to My Assessments</a>
                <a href="{% url 'assessments:manage_questions' assessment.id %}" class="btn" style="font-size: 14px; padding: 0.5rem 1rem; background-color: #666;">Manage Questions</a>
                
                <form method="post" action="{% url 'assessments:delete_assessment' assessment.id %}" 
                      style="margin: 0;" 
                      onsubmit="return confirm('Are you sure you want to delete this assessment? This action cannot be undone.')">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="font-size: 14px; padding: 0.5rem 1rem; background-color: #d32f2f; width: 100%;">Delete Assessment</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
