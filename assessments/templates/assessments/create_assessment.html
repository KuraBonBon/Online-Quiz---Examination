{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Create Assessment - {{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .creation-method-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        background: var(--bg-secondary);
    }
    
    .creation-method-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .creation-method-card.selected {
        border-color: var(--primary-color);
        background: rgba(59, 130, 246, 0.05);
    }
    
    .method-icon {
        width: 48px;
        height: 48px;
        background: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .form-section {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }
    
    .form-section h3 {
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .advanced-options {
        display: none;
    }
    
    .advanced-options.show {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; height: 0; }
        to { opacity: 1; height: auto; }
    }
    
    .toggle-advanced {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 1rem;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
        background: var(--bg-primary);
    }
    
    .progress-indicator {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
    }
    
    .step {
        display: flex;
        align-items: center;
        color: var(--text-secondary);
    }
    
    .step.active {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .step.completed {
        color: #10b981;
    }
    
    .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        margin-right: 0.5rem;
    }
    
    .step.active .step-number {
        background: var(--primary-color);
        color: white;
    }
    
    .step.completed .step-number {
        background: #10b981;
        color: white;
    }
    
    .step-separator {
        width: 2rem;
        height: 1px;
        background: var(--border-color);
        margin: 0 1rem;
    }
    
    /* Dark mode adjustments */
    [data-theme="dark"] .creation-method-card {
        background: var(--bg-secondary);
        border-color: #374151;
    }
    
    [data-theme="dark"] .creation-method-card:hover {
        border-color: var(--primary-color);
    }
    
    [data-theme="dark"] .form-control {
        background: var(--bg-secondary);
        border-color: #374151;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Progress Indicator -->
            <div class="progress-indicator">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <span>Choose Type</span>
                </div>
                <div class="step-separator"></div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <span>Configure Assessment</span>
                </div>
                <div class="step-separator"></div>
                <div class="step">
                    <div class="step-number">3</div>
                    <span>Add Questions</span>
                </div>
                <div class="step-separator"></div>
                <div class="step">
                    <div class="step-number">4</div>
                    <span>Review & Publish</span>
                </div>
            </div>

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h3 mb-1">{{ page_title }}</h2>
                    <p class="text-muted">Configure your {{ assessment_type }} settings and preferences</p>
                </div>
                <a href="{% url 'assessments:assessment_selection' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Selection
                </a>
            </div>

            <!-- Creation Method Info (if applicable) -->
            {% if creation_method != 'manual' %}
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i>
                {% if creation_method == 'template' %}
                    Creating from template - some settings are pre-filled based on the selected template.
                {% elif creation_method == 'import' %}
                    Creating from document import - questions will be added automatically after configuration.
                {% elif creation_method == 'question_bank' %}
                    Creating from question bank - questions will be copied from the selected bank.
                {% endif %}
            </div>
            {% endif %}

            <!-- Assessment Configuration Form -->
            <form method="post" class="assessment-form">
                {% csrf_token %}
                
                <!-- Basic Information Section -->
                <div class="form-section">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        Basic Information
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.assessment_type.id_for_label }}">{{ form.assessment_type.label }}</label>
                            {{ form.assessment_type }}
                            {% if form.assessment_type.errors %}
                                <div class="text-danger small mt-1">{{ form.assessment_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ form.subject_category.id_for_label }}">{{ form.subject_category.label }}</label>
                            {{ form.subject_category }}
                            {% if form.subject_category.errors %}
                                <div class="text-danger small mt-1">{{ form.subject_category.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.difficulty_level.id_for_label }}">{{ form.difficulty_level.label }}</label>
                            {{ form.difficulty_level }}
                            {% if form.difficulty_level.errors %}
                                <div class="text-danger small mt-1">{{ form.difficulty_level.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Timing & Access Section -->
                <div class="form-section">
                    <h3>
                        <i class="fas fa-clock"></i>
                        Timing & Access
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ form.time_limit.id_for_label }}">{{ form.time_limit.label }}</label>
                            <small class="text-muted">Minutes (0 = no limit)</small>
                            {% if form.time_limit.errors %}
                                <div class="text-danger small mt-1">{{ form.time_limit.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.max_attempts.id_for_label }}">{{ form.max_attempts.label }}</label>
                            {{ form.max_attempts }}
                            <small class="text-muted">0 = unlimited</small>
                            {% if form.max_attempts.errors %}
                                <div class="text-danger small mt-1">{{ form.max_attempts.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ form.available_from.id_for_label }}">{{ form.available_from.label }}</label>
                            {{ form.available_from }}
                            {% if form.available_from.errors %}
                                <div class="text-danger small mt-1">{{ form.available_from.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.available_until.id_for_label }}">{{ form.available_until.label }}</label>
                            {{ form.available_until }}
                            {% if form.available_until.errors %}
                                <div class="text-danger small mt-1">{{ form.available_until.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Assessment Settings Section -->
                <div class="form-section">
                    <h3>
                        <i class="fas fa-cog"></i>
                        Assessment Settings
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ form.passing_score.id_for_label }}">{{ form.passing_score.label }}</label>
                            {{ form.passing_score }}
                            <small class="text-muted">Percentage required to pass</small>
                            {% if form.passing_score.errors %}
                                <div class="text-danger small mt-1">{{ form.passing_score.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.instructions.id_for_label }}">{{ form.instructions.label }}</label>
                            {{ form.instructions }}
                            {% if form.instructions.errors %}
                                <div class="text-danger small mt-1">{{ form.instructions.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Behavior Options -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.randomize_questions }}
                                <label class="form-check-label" for="{{ form.randomize_questions.id_for_label }}">
                                    {{ form.randomize_questions.label }}
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                {{ form.randomize_choices }}
                                <label class="form-check-label" for="{{ form.randomize_choices.id_for_label }}">
                                    {{ form.randomize_choices.label }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                {{ form.show_correct_answers }}
                                <label class="form-check-label" for="{{ form.show_correct_answers.id_for_label }}">
                                    {{ form.show_correct_answers.label }}
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                {{ form.allow_review }}
                                <label class="form-check-label" for="{{ form.allow_review.id_for_label }}">
                                    {{ form.allow_review.label }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Options (Collapsible) -->
                <div class="form-section">
                    <h3>
                        <i class="fas fa-sliders-h"></i>
                        Advanced Options
                        <button type="button" class="toggle-advanced" onclick="toggleAdvanced()">
                            <i class="fas fa-chevron-down" id="advanced-icon"></i> Show Advanced
                        </button>
                    </h3>
                    
                    <div class="advanced-options" id="advanced-options">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="{{ form.tags.id_for_label }}">{{ form.tags.label }}</label>
                                {{ form.tags }}
                                <small class="text-muted">Comma-separated tags for organization</small>
                                {% if form.tags.errors %}
                                    <div class="text-danger small mt-1">{{ form.tags.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.show_correct_answers_after.id_for_label }}">{{ form.show_correct_answers_after.label }}</label>
                                {{ form.show_correct_answers_after }}
                                {% if form.show_correct_answers_after.errors %}
                                    <div class="text-danger small mt-1">{{ form.show_correct_answers_after.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.require_proctoring }}
                                    <label class="form-check-label" for="{{ form.require_proctoring.id_for_label }}">
                                        {{ form.require_proctoring.label }}
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    {{ form.lock_questions_after_answered }}
                                    <label class="form-check-label" for="{{ form.lock_questions_after_answered.id_for_label }}">
                                        {{ form.lock_questions_after_answered.label }}
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.show_results_immediately }}
                                    <label class="form-check-label" for="{{ form.show_results_immediately.id_for_label }}">
                                        {{ form.show_results_immediately.label }}
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    {{ form.allow_backtrack }}
                                    <label class="form-check-label" for="{{ form.allow_backtrack.id_for_label }}">
                                        {{ form.allow_backtrack.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between align-items-center pt-4">
                    <a href="{% url 'assessments:assessment_selection' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    
                    <div class="d-flex gap-3">
                        <button type="submit" name="action" value="save_draft" class="btn btn-secondary">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                        <button type="submit" name="action" value="continue" class="btn btn-primary">
                            <i class="fas fa-arrow-right"></i> Continue to Questions
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleAdvanced() {
    const options = document.getElementById('advanced-options');
    const icon = document.getElementById('advanced-icon');
    const button = document.querySelector('.toggle-advanced');
    
    if (options.classList.contains('show')) {
        options.classList.remove('show');
        icon.className = 'fas fa-chevron-down';
        button.innerHTML = '<i class="fas fa-chevron-down" id="advanced-icon"></i> Show Advanced';
    } else {
        options.classList.add('show');
        icon.className = 'fas fa-chevron-up';
        button.innerHTML = '<i class="fas fa-chevron-up" id="advanced-icon"></i> Hide Advanced';
    }
}

// Auto-populate tags based on subject and type
document.addEventListener('DOMContentLoaded', function() {
    const subjectField = document.getElementById('{{ form.subject_category.id_for_label }}');
    const typeField = document.getElementById('{{ form.assessment_type.id_for_label }}');
    const tagsField = document.getElementById('{{ form.tags.id_for_label }}');
    
    function updateTags() {
        if (tagsField.value.trim() === '') {
            let tags = [];
            if (subjectField.value) tags.push(subjectField.value);
            if (typeField.value) tags.push(typeField.value);
            tagsField.value = tags.join(', ');
        }
    }
    
    subjectField.addEventListener('change', updateTags);
    typeField.addEventListener('change', updateTags);
    
    // DateTime picker setup
    document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
        if (!input.value) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            input.min = now.toISOString().slice(0, 16);
        }
    });
});
</script>
{% endblock %}
