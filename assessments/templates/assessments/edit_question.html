{% extends 'accounts/base.html' %}
{% load assessment_filters %}

{% block title %}SPIST - Edit Question{% endblock %}

{% block content %}
<div class="card">
    <div class="text-center">
        <h2>Edit Question</h2>
        <p>{{ question.assessment.title }} • {{ question.get_question_type_display }}</p>
    </div>
</div>

<div class="card" style="max-width: 800px; margin: 2rem auto;">
    <form method="post">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="{{ question_form.question_type.id_for_label }}">Question Type *</label>
            {{ question_form.question_type }}
            {% if question_form.question_type.errors %}
                <div style="color: red; font-size: 14px;">
                    {{ question_form.question_type.errors }}
                </div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ question_form.question_text.id_for_label }}">Question *</label>
            {{ question_form.question_text }}
            {% if question_form.question_text.errors %}
                <div style="color: red; font-size: 14px;">
                    {{ question_form.question_text.errors }}
                </div>
            {% endif %}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="{{ question_form.points.id_for_label }}">Points *</label>
                {{ question_form.points }}
                {% if question_form.points.errors %}
                    <div style="color: red; font-size: 14px;">
                        {{ question_form.points.errors }}
                    </div>
                {% endif %}
            </div>
            
            {% if question.question_type == 'enumeration' %}
            <div class="form-group">
                <label for="{{ question_form.expected_answers_count.id_for_label }}">Expected Answers</label>
                {{ question_form.expected_answers_count }}
                {% if question_form.expected_answers_count.errors %}
                    <div style="color: red; font-size: 14px;">
                        {{ question_form.expected_answers_count.errors }}
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Multiple Choice Options -->
        {% if question.question_type == 'multiple_choice' and choice_formset %}
        <div class="card" style="background-color: #f5f5f5; margin: 1.5rem 0;">
            <h4>Answer Choices</h4>
            <p style="color: #666; margin-bottom: 1rem;">Add 2-10 answer choices. Mark the correct one(s).</p>
            
            {{ choice_formset.management_form }}
            <div id="choice-formset">
                {% for form in choice_formset %}
                    <div class="choice-form" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                        {{ form.id }}
                        <div style="flex: 1;">
                            {{ form.choice_text }}
                            {% if form.choice_text.errors %}
                                <div style="color: red; font-size: 12px;">{{ form.choice_text.errors }}</div>
                            {% endif %}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {{ form.is_correct }}
                            <label for="{{ form.is_correct.id_for_label }}" style="margin: 0; font-size: 14px;">Correct</label>
                        </div>
                        {% if form.DELETE %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {{ form.DELETE }}
                            <label for="{{ form.DELETE.id_for_label }}" style="margin: 0; font-size: 14px; color: #d32f2f;">Delete</label>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- True/False Answer Selection -->
        {% if question.question_type == 'true_false' and true_false_form %}
        <div class="card" style="background-color: #f5f5f5; margin: 1.5rem 0;">
            <h4>Correct Answer</h4>
            <p style="color: #666; margin-bottom: 1rem;">Select the correct answer for this True/False question.</p>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for radio in true_false_form.correct_answer %}
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                    {{ radio.tag }}
                    <label for="{{ radio.id_for_label }}" style="margin: 0; cursor: pointer; font-size: 16px;">
                        {{ radio.choice_label }}
                    </label>
                </div>
                {% endfor %}
            </div>
            
            <!-- Show current status -->
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                <h5>Current Status:</h5>
                {% for choice in question.choices.all %}
                <div style="padding: 0.25rem 0.5rem; margin: 0.25rem 0; border-radius: 4px; {% if choice.is_correct %}background-color: #e8f5e9; border: 1px solid #4caf50;{% else %}background-color: #ffebee; border: 1px solid #f44336;{% endif %}">
                    <span>{{ choice.choice_text }}</span>
                    {% if choice.is_correct %}
                        <span style="color: #2e7d32; font-weight: bold; float: right;">✓ Correct</span>
                    {% else %}
                        <span style="color: #666; float: right;">Incorrect</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <!-- Correct Answers for Identification and Enumeration -->
        {% with question_types='identification,enumeration'|split:',' %}
        {% if question.question_type in question_types and answer_formset %}
        <div class="card" style="background-color: #f5f5f5; margin: 1.5rem 0;">
            <h4>Correct Answers</h4>
            {% if question.question_type == 'identification' %}
                <p style="color: #666; margin-bottom: 1rem;">Add one or more acceptable answers.</p>
            {% elif question.question_type == 'enumeration' %}
                <p style="color: #666; margin-bottom: 1rem;">Add the items that should be listed in the answer.</p>
            {% endif %}
            
            {{ answer_formset.management_form }}
            <div id="answer-formset">
                {% for form in answer_formset %}
                    <div class="answer-form" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                        {{ form.id }}
                        <div style="flex: 1;">
                            {{ form.answer_text }}
                            {% if form.answer_text.errors %}
                                <div style="color: red; font-size: 12px;">{{ form.answer_text.errors }}</div>
                            {% endif %}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {{ form.is_case_sensitive }}
                            <label for="{{ form.is_case_sensitive.id_for_label }}" style="margin: 0; font-size: 14px;">Case Sensitive</label>
                        </div>
                        {% if form.DELETE %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {{ form.DELETE }}
                            <label for="{{ form.DELETE.id_for_label }}" style="margin: 0; font-size: 14px; color: #d32f2f;">Delete</label>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Reference Answers for Essay Questions -->
        {% if question.question_type == 'essay' and reference_formset %}
        <div class="card" style="background-color: #f0f8ff; margin: 1.5rem 0;">
            <h4>Reference Answers</h4>
            <p style="color: #666; margin-bottom: 1rem;">Add key points or sample answers for grading guidance.</p>
            
            {{ reference_formset.management_form }}
            <div id="reference-formset">
                {% for form in reference_formset %}
                    <div class="reference-form" style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                        {{ form.id }}
                        <div style="flex: 1;">
                            {{ form.answer_text }}
                            {% if form.answer_text.errors %}
                                <div style="color: red; font-size: 12px;">{{ form.answer_text.errors }}</div>
                            {% endif %}
                        </div>
                        {% if form.DELETE %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {{ form.DELETE }}
                            <label for="{{ form.DELETE.id_for_label }}" style="margin: 0; font-size: 14px; color: #d32f2f;">Delete</label>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="form-group text-center" style="margin-top: 2rem;">
            <button type="submit" class="btn">Update Question</button>
            <a href="{% url 'assessments:manage_questions' question.assessment.id %}" class="btn" style="background-color: #666; margin-left: 1rem;">Cancel</a>
        </div>
    </form>
</div>

<style>
.form-group label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
}

.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: #2e7d32;
    box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
}

input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #2e7d32;
}
</style>
{% endblock %}
