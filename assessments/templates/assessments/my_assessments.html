{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}My Assessments - SPIST{% endblock %}

{% block extra_css %}
<style>
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
    }
    
    .stat-icon.primary { background: var(--primary-color); }
    .stat-icon.success { background: #10b981; }
    .stat-icon.warning { background: #f59e0b; }
    .stat-icon.info { background: #3b82f6; }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .filters-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }
    
    .assessment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    
    .assessment-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .assessment-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .assessment-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }
    
    .assessment-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .assessment-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .badge.status-published {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .badge.status-draft {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .badge.status-archived {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
        border: 1px solid rgba(107, 114, 128, 0.2);
    }
    
    .badge.type {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .assessment-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        line-height: 1.4;
    }
    
    .assessment-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 8px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .stat-key {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .assessment-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }
    
    .assessment-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 6px;
    }
    
    .bulk-actions {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .bulk-actions.show {
        display: block;
    }
    
    .bulk-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }
    
    .selected-count {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .pagination-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .pagination {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .page-link {
        padding: 0.5rem 0.75rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .page-link:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }
    
    .empty-icon {
        width: 64px;
        height: 64px;
        background: var(--bg-secondary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 2rem;
        margin: 0 auto 1rem;
    }
    
    /* Dark mode adjustments */
    [data-theme="dark"] .assessment-card {
        background: var(--bg-secondary);
        border-color: #374151;
    }
    
    [data-theme="dark"] .assessment-stats {
        background: var(--bg-primary);
    }
    
    [data-theme="dark"] .filters-card {
        background: var(--bg-secondary);
        border-color: #374151;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-1">My Assessments</h2>
            <p class="text-muted">Manage your quizzes, exams, and practice tests</p>
        </div>
        <a href="{% url 'assessments:assessment_selection' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Assessment
        </a>
    </div>

    <!-- Dashboard Statistics -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-number">{{ stats.total_assessments }}</div>
            <div class="stat-label">Total Assessments</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-number">{{ stats.published_assessments }}</div>
            <div class="stat-label">Published</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-edit"></i>
            </div>
            <div class="stat-number">{{ stats.draft_assessments }}</div>
            <div class="stat-label">Drafts</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-number">{{ stats.total_attempts }}</div>
            <div class="stat-label">Total Attempts</div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-card">
        <form method="get" class="filter-form">
            <div class="filter-grid">
                <div class="form-group">
                    <label for="{{ filter_form.search.id_for_label }}">Search</label>
                    {{ filter_form.search }}
                </div>
                
                <div class="form-group">
                    <label for="{{ filter_form.status.id_for_label }}">Status</label>
                    {{ filter_form.status }}
                </div>
                
                <div class="form-group">
                    <label for="{{ filter_form.assessment_type.id_for_label }}">Type</label>
                    {{ filter_form.assessment_type }}
                </div>
                
                <div class="form-group">
                    <label for="{{ filter_form.subject_category.id_for_label }}">Subject</label>
                    {{ filter_form.subject_category }}
                </div>
                
                <div class="form-group">
                    <label for="{{ filter_form.sort_by.id_for_label }}">Sort By</label>
                    {{ filter_form.sort_by }}
                </div>
                
                <div class="form-group d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Filter
                    </button>
                    <a href="{% url 'assessments:my_assessments' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Clear
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Bulk Actions (Hidden by default) -->
    <div class="bulk-actions" id="bulk-actions">
        <div class="bulk-actions-bar">
            <div>
                <span class="selected-count" id="selected-count">0</span> assessment(s) selected
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-success btn-sm" onclick="bulkAction('publish')">
                    <i class="fas fa-globe"></i> Publish
                </button>
                <button type="button" class="btn btn-warning btn-sm" onclick="bulkAction('archive')">
                    <i class="fas fa-archive"></i> Archive
                </button>
                <button type="button" class="btn btn-info btn-sm" onclick="bulkAction('duplicate')">
                    <i class="fas fa-copy"></i> Duplicate
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="bulkAction('delete')">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSelection()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Assessments Grid -->
    {% if page_obj %}
    <div class="assessment-grid">
        {% for assessment in page_obj %}
        <div class="assessment-card" data-assessment-id="{{ assessment.id }}">
            <!-- Selection Checkbox -->
            <input type="checkbox" class="assessment-checkbox position-absolute" 
                   style="top: 1rem; right: 1rem; z-index: 10;"
                   onchange="updateSelection()">
            
            <div class="assessment-header">
                <div class="flex-grow-1">
                    <h3 class="assessment-title">{{ assessment.title }}</h3>
                    <div class="assessment-badges">
                        <span class="badge status-{{ assessment.status }}">
                            {{ assessment.get_status_display }}
                        </span>
                        <span class="badge type">
                            {{ assessment.get_assessment_type_display }}
                        </span>
                    </div>
                </div>
            </div>
            
            {% if assessment.description %}
            <p class="assessment-description">
                {{ assessment.description|truncatechars:120 }}
            </p>
            {% endif %}
            
            <div class="assessment-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ assessment.question_count|default:0 }}</div>
                    <div class="stat-key">Questions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ assessment.attempt_count|default:0 }}</div>
                    <div class="stat-key">Attempts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        {% if assessment.avg_score %}{{ assessment.avg_score|floatformat:1 }}%{% else %}â€”{% endif %}
                    </div>
                    <div class="stat-key">Avg Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ assessment.view_count|default:0 }}</div>
                    <div class="stat-key">Views</div>
                </div>
            </div>
            
            <div class="assessment-meta">
                <span>
                    <i class="fas fa-calendar"></i>
                    Created {{ assessment.created_at|timesince }} ago
                </span>
                {% if assessment.time_limit %}
                <span>
                    <i class="fas fa-clock"></i>
                    {{ assessment.time_limit }} min
                </span>
                {% endif %}
            </div>
            
            <div class="assessment-actions">
                <a href="{% url 'assessments:manage_questions' assessment.id %}" 
                   class="btn btn-primary btn-sm">
                    <i class="fas fa-edit"></i> Manage
                </a>
                
                {% if assessment.status == 'published' %}
                <a href="{% url 'assessments:assessment_detail' assessment.id %}" 
                   class="btn btn-info btn-sm">
                    <i class="fas fa-eye"></i> View
                </a>
                {% endif %}
                
                <button type="button" class="btn btn-success btn-sm" 
                        onclick="duplicateAssessment({{ assessment.id }})">
                    <i class="fas fa-copy"></i> Copy
                </button>
                
                <div class="dropdown d-inline">
                    <button class="btn btn-secondary btn-sm dropdown-toggle" 
                            type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="{% url 'assessments:edit_assessment' assessment.id %}">
                                <i class="fas fa-edit"></i> Edit Settings
                            </a>
                        </li>
                        {% if assessment.status == 'draft' %}
                        <li>
                            <button class="dropdown-item" onclick="publishAssessment({{ assessment.id }})">
                                <i class="fas fa-globe"></i> Publish
                            </button>
                        </li>
                        {% elif assessment.status == 'published' %}
                        <li>
                            <button class="dropdown-item" onclick="archiveAssessment({{ assessment.id }})">
                                <i class="fas fa-archive"></i> Archive
                            </button>
                        </li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item text-danger" onclick="deleteAssessment({{ assessment.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-wrapper">
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1" class="page-link">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?page={{ page_obj.previous_page_number }}" class="page-link">
                    <i class="fas fa-angle-left"></i>
                </a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="page-link active">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="page-link">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-clipboard-list"></i>
        </div>
        <h4>No Assessments Found</h4>
        <p>You haven't created any assessments yet. Get started by creating your first quiz or exam!</p>
        <a href="{% url 'assessments:assessment_selection' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Your First Assessment
        </a>
    </div>
    {% endif %}
</div>

<!-- Bulk Action Form (Hidden) -->
<form id="bulk-form" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="bulk_action" value="1">
    <input type="hidden" name="action" id="bulk-action-type">
    <input type="hidden" name="assessment_ids" id="bulk-assessment-ids">
</form>
{% endblock %}

{% block extra_js %}
<script>
let selectedAssessments = new Set();

function updateSelection() {
    const checkboxes = document.querySelectorAll('.assessment-checkbox:checked');
    selectedAssessments.clear();
    
    checkboxes.forEach(checkbox => {
        const card = checkbox.closest('.assessment-card');
        const assessmentId = card.dataset.assessmentId;
        selectedAssessments.add(assessmentId);
    });
    
    const count = selectedAssessments.size;
    document.getElementById('selected-count').textContent = count;
    
    const bulkActions = document.getElementById('bulk-actions');
    if (count > 0) {
        bulkActions.classList.add('show');
    } else {
        bulkActions.classList.remove('show');
    }
}

function clearSelection() {
    document.querySelectorAll('.assessment-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelection();
}

function bulkAction(action) {
    if (selectedAssessments.size === 0) {
        alert('Please select assessments first.');
        return;
    }
    
    let confirmMessage = '';
    switch(action) {
        case 'delete':
            confirmMessage = `Are you sure you want to delete ${selectedAssessments.size} assessment(s)? This action cannot be undone.`;
            break;
        case 'publish':
            confirmMessage = `Publish ${selectedAssessments.size} assessment(s)?`;
            break;
        case 'archive':
            confirmMessage = `Archive ${selectedAssessments.size} assessment(s)?`;
            break;
        case 'duplicate':
            confirmMessage = `Create copies of ${selectedAssessments.size} assessment(s)?`;
            break;
    }
    
    if (confirm(confirmMessage)) {
        document.getElementById('bulk-action-type').value = action;
        document.getElementById('bulk-assessment-ids').value = Array.from(selectedAssessments).join(',');
        document.getElementById('bulk-form').submit();
    }
}

// Individual action functions
function duplicateAssessment(id) {
    if (confirm('Create a copy of this assessment?')) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'post';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="bulk_action" value="1">
            <input type="hidden" name="action" value="duplicate">
            <input type="hidden" name="assessment_ids" value="${id}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

function publishAssessment(id) {
    if (confirm('Publish this assessment? Students will be able to access it.')) {
        const form = document.createElement('form');
        form.method = 'post';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="bulk_action" value="1">
            <input type="hidden" name="action" value="publish">
            <input type="hidden" name="assessment_ids" value="${id}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

function archiveAssessment(id) {
    if (confirm('Archive this assessment? It will no longer be accessible to students.')) {
        const form = document.createElement('form');
        form.method = 'post';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="bulk_action" value="1">
            <input type="hidden" name="action" value="archive">
            <input type="hidden" name="assessment_ids" value="${id}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteAssessment(id) {
    if (confirm('Are you sure you want to delete this assessment? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'post';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="bulk_action" value="1">
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="assessment_ids" value="${id}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Initialize tooltips and dropdowns if using Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    // Auto-clear old flash messages
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);
});
</script>
{% endblock %}
