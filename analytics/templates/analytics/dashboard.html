{% extends 'accounts/base.html' %}

{% block title %}SPIST - Analytics Dashboard{% endblock %}

{% block content %}
<!-- Analytics Header -->
<div class="analytics-header">
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="analytics-title">
                <i class="fas fa-chart-line me-3"></i>Analytics Dashboard
            </h1>
            <p class="analytics-subtitle">Comprehensive insights into system performance and user engagement</p>
        </div>
        <div class="col-md-4">
            <div class="analytics-controls">
                <select class="form-select" id="periodFilter" onchange="filterByPeriod(this.value)">
                    <option value="7" {% if period == '7' %}selected{% endif %}>Last 7 days</option>
                    <option value="30" {% if period == '30' %}selected{% endif %}>Last 30 days</option>
                    <option value="90" {% if period == '90' %}selected{% endif %}>Last 90 days</option>
                    <option value="365" {% if period == '365' %}selected{% endif %}>Last year</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Overview -->
<div class="analytics-overview mb-5">
    <div class="row g-4">
        <div class="col-xl-3 col-md-6">
            <div class="metric-card metric-primary">
                <div class="metric-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-content">
                    <h3 class="metric-number">{{ system_metrics.total_users|floatformat:0 }}</h3>
                    <p class="metric-label">Total Users</p>
                    <div class="metric-trend">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="trend-percentage">+{{ growth_trends.user_growth|floatformat:1 }}%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="metric-card metric-success">
                <div class="metric-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="metric-content">
                    <h3 class="metric-number">{{ system_metrics.published_assessments }}</h3>
                    <p class="metric-label">Active Assessments</p>
                    <div class="metric-trend">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="trend-percentage">+{{ growth_trends.assessment_growth|floatformat:1 }}%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="metric-card metric-info">
                <div class="metric-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="metric-content">
                    <h3 class="metric-number">{{ system_metrics.average_score|floatformat:1 }}%</h3>
                    <p class="metric-label">Average Score</p>
                    <div class="metric-trend">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="trend-percentage">+2.3%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="metric-card metric-warning">
                <div class="metric-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="metric-content">
                    <h3 class="metric-number">{{ system_metrics.completed_attempts }}</h3>
                    <p class="metric-label">Completed Attempts</p>
                    <div class="metric-trend">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="trend-percentage">+15.7%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Analytics Grid -->
<div class="row g-4">
    <!-- Performance Overview Chart -->
    <div class="col-lg-8">
        <div class="analytics-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-line-chart me-2"></i>Performance Overview
                </h5>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assessment Distribution -->
    <div class="col-lg-4">
        <div class="analytics-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-pie-chart me-2"></i>Assessment Types
                </h5>
            </div>
            <div class="card-body">
                <div class="assessment-distribution">
                    <div class="distribution-item">
                        <div class="item-info">
                            <span class="item-label">Quizzes</span>
                            <span class="item-count">{{ assessment_stats.quiz_count }}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" style="width: 65%"></div>
                        </div>
                    </div>
                    <div class="distribution-item">
                        <div class="item-info">
                            <span class="item-label">Exams</span>
                            <span class="item-count">{{ assessment_stats.exam_count }}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: 35%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="average-scores mt-4">
                    <h6>Average Scores</h6>
                    <div class="score-item">
                        <span>Quiz Average:</span>
                        <strong class="text-primary">{{ assessment_stats.avg_quiz_score|floatformat:1 }}%</strong>
                    </div>
                    <div class="score-item">
                        <span>Exam Average:</span>
                        <strong class="text-success">{{ assessment_stats.avg_exam_score|floatformat:1 }}%</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Performers -->
    <div class="col-lg-6">
        <div class="analytics-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-trophy me-2"></i>Top Performers
                </h5>
                <div class="card-actions">
                    <a href="{% url 'analytics:student_analytics' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
            </div>
            <div class="card-body">
                <div class="top-performers-list">
                    {% for student in top_students %}
                    <div class="performer-item">
                        <div class="performer-rank">{{ forloop.counter }}</div>
                        <div class="performer-info">
                            <h6 class="performer-name">{{ student.student__first_name }} {{ student.student__last_name }}</h6>
                            <small class="performer-email">{{ student.student__email }}</small>
                        </div>
                        <div class="performer-stats">
                            <div class="stat-score">{{ student.avg_score|floatformat:1 }}%</div>
                            <small class="stat-attempts">{{ student.total_attempts }} attempts</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-users-slash text-muted"></i>
                        <p class="text-muted mt-2">No student data available for this period</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-lg-6">
        <div class="analytics-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-activity me-2"></i>Recent Activity
                </h5>
                <div class="card-actions">
                    <span class="badge bg-success pulse">Live</span>
                </div>
            </div>
            <div class="card-body">
                <div class="activity-timeline">
                    {% for activity in recent_activities %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            {% if activity.action_type == 'assessment_create' %}
                                <i class="fas fa-plus-circle text-primary"></i>
                            {% elif activity.action_type == 'assessment_complete' %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% elif activity.action_type == 'login' %}
                                <i class="fas fa-sign-in-alt text-info"></i>
                            {% else %}
                                <i class="fas fa-circle text-secondary"></i>
                            {% endif %}
                        </div>
                        <div class="activity-content">
                            <div class="activity-description">
                                <strong>{{ activity.user.first_name }} {{ activity.user.last_name }}</strong>
                                {{ activity.get_action_type_display|lower }}
                            </div>
                            <small class="activity-time">{{ activity.timestamp|timesince }} ago</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-clock text-muted"></i>
                        <p class="text-muted mt-2">No recent activity</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Navigation -->
<div class="analytics-navigation mt-5">
    <div class="row g-3">
        <div class="col-md-3">
            <a href="{% url 'analytics:student_analytics' %}" class="nav-card nav-primary">
                <div class="nav-icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="nav-content">
                    <h6>Student Analytics</h6>
                    <p>Performance insights and detailed reports</p>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{% url 'analytics:teacher_analytics' %}" class="nav-card nav-success">
                <div class="nav-icon">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="nav-content">
                    <h6>Teacher Analytics</h6>
                    <p>Faculty activity and effectiveness metrics</p>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{% url 'analytics:assessment_analytics' %}" class="nav-card nav-info">
                <div class="nav-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="nav-content">
                    <h6>Assessment Analytics</h6>
                    <p>Quiz and exam performance analysis</p>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            {% if user.is_staff %}
            <a href="{% url 'analytics:system_analytics' %}" class="nav-card nav-warning">
                <div class="nav-icon">
                    <i class="fas fa-server"></i>
                </div>
                <div class="nav-content">
                    <h6>System Analytics</h6>
                    <p>System usage and performance metrics</p>
                </div>
            </a>
            {% else %}
            <div class="nav-card nav-disabled">
                <div class="nav-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="nav-content">
                    <h6>System Analytics</h6>
                    <p>Admin access required</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
:root {
    --analytics-primary: #3b82f6;
    --analytics-success: #10b981;
    --analytics-info: #06b6d4;
    --analytics-warning: #f59e0b;
    --analytics-danger: #ef4444;
    --analytics-bg: #f8fafc;
    --analytics-card-bg: #ffffff;
    --analytics-border: #e2e8f0;
    --analytics-text: #1e293b;
    --analytics-text-muted: #64748b;
}

[data-bs-theme="dark"] {
    --analytics-bg: #1e293b;
    --analytics-card-bg: #334155;
    --analytics-border: #475569;
    --analytics-text: #f1f5f9;
    --analytics-text-muted: #cbd5e1;
}

.analytics-header {
    margin-bottom: 2rem;
    padding: 2rem 0;
    background: linear-gradient(135deg, var(--analytics-primary), #6366f1);
    border-radius: 16px;
    color: white;
    margin: -1rem -1rem 2rem -1rem;
    padding: 2rem 2rem;
}

.analytics-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.analytics-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.analytics-controls .form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    backdrop-filter: blur(10px);
}

.analytics-controls .form-select:focus {
    border-color: rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
}

.analytics-overview {
    margin: 2rem 0;
}

.metric-card {
    background: var(--analytics-card-bg);
    border: 1px solid var(--analytics-border);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    border-radius: 16px 16px 0 0;
}

.metric-primary::before { background: var(--analytics-primary); }
.metric-success::before { background: var(--analytics-success); }
.metric-info::before { background: var(--analytics-info); }
.metric-warning::before { background: var(--analytics-warning); }

.metric-card {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.metric-primary .metric-icon {
    background: rgba(59, 130, 246, 0.1);
    color: var(--analytics-primary);
}

.metric-success .metric-icon {
    background: rgba(16, 185, 129, 0.1);
    color: var(--analytics-success);
}

.metric-info .metric-icon {
    background: rgba(6, 182, 212, 0.1);
    color: var(--analytics-info);
}

.metric-warning .metric-icon {
    background: rgba(245, 158, 11, 0.1);
    color: var(--analytics-warning);
}

.metric-content {
    flex: 1;
}

.metric-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--analytics-text);
    margin: 0;
    line-height: 1;
}

.metric-label {
    color: var(--analytics-text-muted);
    margin: 0.25rem 0 0.5rem 0;
    font-size: 0.9rem;
    font-weight: 500;
}

.metric-trend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.trend-percentage {
    color: #10b981;
}

.analytics-card {
    background: var(--analytics-card-bg);
    border: 1px solid var(--analytics-border);
    border-radius: 16px;
    overflow: hidden;
    height: 100%;
}

.analytics-card .card-header {
    background: var(--analytics-card-bg);
    border-bottom: 1px solid var(--analytics-border);
    padding: 1.5rem;
    display: flex;
    justify-content: between;
    align-items: center;
}

.analytics-card .card-title {
    margin: 0;
    color: var(--analytics-text);
    font-weight: 600;
    flex: 1;
}

.analytics-card .card-body {
    padding: 1.5rem;
}

.chart-container {
    position: relative;
    height: 300px;
}

.assessment-distribution {
    margin-bottom: 1.5rem;
}

.distribution-item {
    margin-bottom: 1rem;
}

.item-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.item-label {
    color: var(--analytics-text);
    font-weight: 500;
}

.item-count {
    color: var(--analytics-text-muted);
    font-weight: 600;
}

.progress {
    height: 8px;
    background: var(--analytics-border);
    border-radius: 4px;
}

.average-scores h6 {
    color: var(--analytics-text);
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.score-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    color: var(--analytics-text-muted);
}

.top-performers-list {
    max-height: 400px;
    overflow-y: auto;
}

.performer-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--analytics-border);
}

.performer-item:last-child {
    border-bottom: none;
}

.performer-rank {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--analytics-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
}

.performer-info {
    flex: 1;
}

.performer-name {
    margin: 0;
    color: var(--analytics-text);
    font-size: 0.9rem;
}

.performer-email {
    color: var(--analytics-text-muted);
}

.performer-stats {
    text-align: right;
}

.stat-score {
    font-weight: 700;
    color: var(--analytics-success);
    font-size: 1.1rem;
}

.stat-attempts {
    color: var(--analytics-text-muted);
}

.activity-timeline {
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--analytics-border);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--analytics-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
}

.activity-description {
    color: var(--analytics-text);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.activity-time {
    color: var(--analytics-text-muted);
}

.analytics-navigation {
    margin-top: 3rem;
}

.nav-card {
    display: block;
    background: var(--analytics-card-bg);
    border: 1px solid var(--analytics-border);
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
    overflow: hidden;
}

.nav-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    text-decoration: none;
}

.nav-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    border-radius: 12px 12px 0 0;
}

.nav-primary::before { background: var(--analytics-primary); }
.nav-success::before { background: var(--analytics-success); }
.nav-info::before { background: var(--analytics-info); }
.nav-warning::before { background: var(--analytics-warning); }

.nav-card {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.nav-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.nav-primary .nav-icon {
    background: rgba(59, 130, 246, 0.1);
    color: var(--analytics-primary);
}

.nav-success .nav-icon {
    background: rgba(16, 185, 129, 0.1);
    color: var(--analytics-success);
}

.nav-info .nav-icon {
    background: rgba(6, 182, 212, 0.1);
    color: var(--analytics-info);
}

.nav-warning .nav-icon {
    background: rgba(245, 158, 11, 0.1);
    color: var(--analytics-warning);
}

.nav-content h6 {
    margin: 0 0 0.25rem 0;
    color: var(--analytics-text);
    font-weight: 600;
}

.nav-content p {
    margin: 0;
    color: var(--analytics-text-muted);
    font-size: 0.875rem;
}

.nav-disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.nav-disabled:hover {
    transform: none;
    box-shadow: none;
}

.empty-state {
    text-align: center;
    padding: 2rem;
}

.empty-state i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

@media (max-width: 768px) {
    .analytics-header {
        margin: -1rem -0.5rem 1rem -0.5rem;
        padding: 1.5rem 1rem;
    }
    
    .analytics-title {
        font-size: 1.75rem;
    }
    
    .metric-card {
        text-align: center;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .performer-item,
    .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .nav-card {
        text-align: center;
        flex-direction: column;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performance Chart
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [{
            label: 'Average Score',
            data: [75, 82, 78, 85],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }, {
            label: 'Completion Rate',
            data: [60, 70, 65, 75],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

function filterByPeriod(period) {
    const url = new URL(window.location);
    url.searchParams.set('period', period);
    window.location.href = url.toString();
}

// Auto-refresh data every 30 seconds
setInterval(() => {
    // Implement live data refresh if needed
}, 30000);
</script>
{% endblock %}
